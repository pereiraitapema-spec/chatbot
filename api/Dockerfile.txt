# ===== base =====
FROM python:3.11-slim AS base
WORKDIR /app/api
RUN pip install --no-cache-dir uv==0.8.9

# ===== packages =====
FROM base AS packages
COPY api/pyproject.toml api/uv.lock ./
RUN uv sync --locked --no-dev

# ===== production =====
FROM base AS production

# cria diretórios
RUN mkdir -p /app/api /api/docker

# copia código
COPY api/ /app/api/

# copia entrypoint (CAMINHO REAL DO REPO)
COPY api/docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# usuário
RUN groupadd -r -g 1001 dify \
 && useradd -r -u 1001 -g 1001 -s /bin/bash dify \
 && chown -R dify:dify /app

USER dify
WORKDIR /app/api

ENTRYPOINT ["bash", "/entrypoint.sh"]
